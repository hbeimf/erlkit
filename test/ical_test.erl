-module(ical_test).

-include_lib("eunit/include/eunit.hrl").

rrule_test(Rule, Start, Result) ->
    rrule_test(Rule, Start, {undefined, undefined}, Result).

rrule_test(Rule, Start, Range, Result) when is_list(Start) ->
    rrule_test(Rule, list_to_binary(Start), Range, Result);
rrule_test(Rule, Start, Range, Result) when is_list(Rule) ->
    rrule_test(list_to_binary(Rule), Start, Range, Result);
rrule_test(Rule, Start, Range, Result) ->
    ?assertMatch(Result, ical:recur(ical:parse(date, Start),
                                    ical:rrule(Rule),
                                    Range)).

%% rrule examples from rfc2445

rrule_example1_test() ->
    rrule_test("RRULE:FREQ=DAILY;COUNT=10",
               "19970902T090000Z",
               [{{1997,9,2},{9,0,0}},
                {{1997,9,3},{9,0,0}},
                {{1997,9,4},{9,0,0}},
                {{1997,9,5},{9,0,0}},
                {{1997,9,6},{9,0,0}},
                {{1997,9,7},{9,0,0}},
                {{1997,9,8},{9,0,0}},
                {{1997,9,9},{9,0,0}},
                {{1997,9,10},{9,0,0}},
                {{1997,9,11},{9,0,0}}]).

rrule_example2_test() ->
    rrule_test("RRULE:FREQ=DAILY;UNTIL=19971224T000000Z",
               "19970902T090000Z",
               [{{1997,9,2},{9,0,0}},
                {{1997,9,3},{9,0,0}},
                {{1997,9,4},{9,0,0}},
                {{1997,9,5},{9,0,0}},
                {{1997,9,6},{9,0,0}},
                {{1997,9,7},{9,0,0}},
                {{1997,9,8},{9,0,0}},
                {{1997,9,9},{9,0,0}},
                {{1997,9,10},{9,0,0}},
                {{1997,9,11},{9,0,0}},
                {{1997,9,12},{9,0,0}},
                {{1997,9,13},{9,0,0}},
                {{1997,9,14},{9,0,0}},
                {{1997,9,15},{9,0,0}},
                {{1997,9,16},{9,0,0}},
                {{1997,9,17},{9,0,0}},
                {{1997,9,18},{9,0,0}},
                {{1997,9,19},{9,0,0}},
                {{1997,9,20},{9,0,0}},
                {{1997,9,21},{9,0,0}},
                {{1997,9,22},{9,0,0}},
                {{1997,9,23},{9,0,0}},
                {{1997,9,24},{9,0,0}},
                {{1997,9,25},{9,0,0}},
                {{1997,9,26},{9,0,0}},
                {{1997,9,27},{9,0,0}},
                {{1997,9,28},{9,0,0}},
                {{1997,9,29},{9,0,0}},
                {{1997,9,30},{9,0,0}},
                {{1997,10,1},{9,0,0}},
                {{1997,10,2},{9,0,0}},
                {{1997,10,3},{9,0,0}},
                {{1997,10,4},{9,0,0}},
                {{1997,10,5},{9,0,0}},
                {{1997,10,6},{9,0,0}},
                {{1997,10,7},{9,0,0}},
                {{1997,10,8},{9,0,0}},
                {{1997,10,9},{9,0,0}},
                {{1997,10,10},{9,0,0}},
                {{1997,10,11},{9,0,0}},
                {{1997,10,12},{9,0,0}},
                {{1997,10,13},{9,0,0}},
                {{1997,10,14},{9,0,0}},
                {{1997,10,15},{9,0,0}},
                {{1997,10,16},{9,0,0}},
                {{1997,10,17},{9,0,0}},
                {{1997,10,18},{9,0,0}},
                {{1997,10,19},{9,0,0}},
                {{1997,10,20},{9,0,0}},
                {{1997,10,21},{9,0,0}},
                {{1997,10,22},{9,0,0}},
                {{1997,10,23},{9,0,0}},
                {{1997,10,24},{9,0,0}},
                {{1997,10,25},{9,0,0}},
                {{1997,10,26},{9,0,0}},
                {{1997,10,27},{9,0,0}},
                {{1997,10,28},{9,0,0}},
                {{1997,10,29},{9,0,0}},
                {{1997,10,30},{9,0,0}},
                {{1997,10,31},{9,0,0}},
                {{1997,11,1},{9,0,0}},
                {{1997,11,2},{9,0,0}},
                {{1997,11,3},{9,0,0}},
                {{1997,11,4},{9,0,0}},
                {{1997,11,5},{9,0,0}},
                {{1997,11,6},{9,0,0}},
                {{1997,11,7},{9,0,0}},
                {{1997,11,8},{9,0,0}},
                {{1997,11,9},{9,0,0}},
                {{1997,11,10},{9,0,0}},
                {{1997,11,11},{9,0,0}},
                {{1997,11,12},{9,0,0}},
                {{1997,11,13},{9,0,0}},
                {{1997,11,14},{9,0,0}},
                {{1997,11,15},{9,0,0}},
                {{1997,11,16},{9,0,0}},
                {{1997,11,17},{9,0,0}},
                {{1997,11,18},{9,0,0}},
                {{1997,11,19},{9,0,0}},
                {{1997,11,20},{9,0,0}},
                {{1997,11,21},{9,0,0}},
                {{1997,11,22},{9,0,0}},
                {{1997,11,23},{9,0,0}},
                {{1997,11,24},{9,0,0}},
                {{1997,11,25},{9,0,0}},
                {{1997,11,26},{9,0,0}},
                {{1997,11,27},{9,0,0}},
                {{1997,11,28},{9,0,0}},
                {{1997,11,29},{9,0,0}},
                {{1997,11,30},{9,0,0}},
                {{1997,12,1},{9,0,0}},
                {{1997,12,2},{9,0,0}},
                {{1997,12,3},{9,0,0}},
                {{1997,12,4},{9,0,0}},
                {{1997,12,5},{9,0,0}},
                {{1997,12,6},{9,0,0}},
                {{1997,12,7},{9,0,0}},
                {{1997,12,8},{9,0,0}},
                {{1997,12,9},{9,0,0}},
                {{1997,12,10},{9,0,0}},
                {{1997,12,11},{9,0,0}},
                {{1997,12,12},{9,0,0}},
                {{1997,12,13},{9,0,0}},
                {{1997,12,14},{9,0,0}},
                {{1997,12,15},{9,0,0}},
                {{1997,12,16},{9,0,0}},
                {{1997,12,17},{9,0,0}},
                {{1997,12,18},{9,0,0}},
                {{1997,12,19},{9,0,0}},
                {{1997,12,20},{9,0,0}},
                {{1997,12,21},{9,0,0}},
                {{1997,12,22},{9,0,0}},
                {{1997,12,23},{9,0,0}}]).

rrule_example3_test() ->
    rrule_test("RRULE:FREQ=DAILY;INTERVAL=2",
               "19970902T090000Z",
               {undefined, {{1997, 10, 25}, {0, 0, 0}}},
               [{{1997,9,2},{9,0,0}},
                {{1997,9,4},{9,0,0}},
                {{1997,9,6},{9,0,0}},
                {{1997,9,8},{9,0,0}},
                {{1997,9,10},{9,0,0}},
                {{1997,9,12},{9,0,0}},
                {{1997,9,14},{9,0,0}},
                {{1997,9,16},{9,0,0}},
                {{1997,9,18},{9,0,0}},
                {{1997,9,20},{9,0,0}},
                {{1997,9,22},{9,0,0}},
                {{1997,9,24},{9,0,0}},
                {{1997,9,26},{9,0,0}},
                {{1997,9,28},{9,0,0}},
                {{1997,9,30},{9,0,0}},
                {{1997,10,2},{9,0,0}},
                {{1997,10,4},{9,0,0}},
                {{1997,10,6},{9,0,0}},
                {{1997,10,8},{9,0,0}},
                {{1997,10,10},{9,0,0}},
                {{1997,10,12},{9,0,0}},
                {{1997,10,14},{9,0,0}},
                {{1997,10,16},{9,0,0}},
                {{1997,10,18},{9,0,0}},
                {{1997,10,20},{9,0,0}},
                {{1997,10,22},{9,0,0}},
                {{1997,10,24},{9,0,0}}]).

rrule_example4_test() ->
    rrule_test("RRULE:FREQ=DAILY;INTERVAL=10;COUNT=5",
               "19970902T090000Z",
               [{{1997,9,2},{9,0,0}},
                {{1997,9,12},{9,0,0}},
                {{1997,9,22},{9,0,0}},
                {{1997,10,2},{9,0,0}},
                {{1997,10,12},{9,0,0}}]).

rrule_example5_test() ->
    Result = [{{1998,1,1},{9,0,0}},
              {{1998,1,2},{9,0,0}},
              {{1998,1,3},{9,0,0}},
              {{1998,1,4},{9,0,0}},
              {{1998,1,5},{9,0,0}},
              {{1998,1,6},{9,0,0}},
              {{1998,1,7},{9,0,0}},
              {{1998,1,8},{9,0,0}},
              {{1998,1,9},{9,0,0}},
              {{1998,1,10},{9,0,0}},
              {{1998,1,11},{9,0,0}},
              {{1998,1,12},{9,0,0}},
              {{1998,1,13},{9,0,0}},
              {{1998,1,14},{9,0,0}},
              {{1998,1,15},{9,0,0}},
              {{1998,1,16},{9,0,0}},
              {{1998,1,17},{9,0,0}},
              {{1998,1,18},{9,0,0}},
              {{1998,1,19},{9,0,0}},
              {{1998,1,20},{9,0,0}},
              {{1998,1,21},{9,0,0}},
              {{1998,1,22},{9,0,0}},
              {{1998,1,23},{9,0,0}},
              {{1998,1,24},{9,0,0}},
              {{1998,1,25},{9,0,0}},
              {{1998,1,26},{9,0,0}},
              {{1998,1,27},{9,0,0}},
              {{1998,1,28},{9,0,0}},
              {{1998,1,29},{9,0,0}},
              {{1998,1,30},{9,0,0}},
              {{1998,1,31},{9,0,0}},
              {{1999,1,1},{9,0,0}},
              {{1999,1,2},{9,0,0}},
              {{1999,1,3},{9,0,0}},
              {{1999,1,4},{9,0,0}},
              {{1999,1,5},{9,0,0}},
              {{1999,1,6},{9,0,0}},
              {{1999,1,7},{9,0,0}},
              {{1999,1,8},{9,0,0}},
              {{1999,1,9},{9,0,0}},
              {{1999,1,10},{9,0,0}},
              {{1999,1,11},{9,0,0}},
              {{1999,1,12},{9,0,0}},
              {{1999,1,13},{9,0,0}},
              {{1999,1,14},{9,0,0}},
              {{1999,1,15},{9,0,0}},
              {{1999,1,16},{9,0,0}},
              {{1999,1,17},{9,0,0}},
              {{1999,1,18},{9,0,0}},
              {{1999,1,19},{9,0,0}},
              {{1999,1,20},{9,0,0}},
              {{1999,1,21},{9,0,0}},
              {{1999,1,22},{9,0,0}},
              {{1999,1,23},{9,0,0}},
              {{1999,1,24},{9,0,0}},
              {{1999,1,25},{9,0,0}},
              {{1999,1,26},{9,0,0}},
              {{1999,1,27},{9,0,0}},
              {{1999,1,28},{9,0,0}},
              {{1999,1,29},{9,0,0}},
              {{1999,1,30},{9,0,0}},
              {{1999,1,31},{9,0,0}},
              {{2000,1,1},{9,0,0}},
              {{2000,1,2},{9,0,0}},
              {{2000,1,3},{9,0,0}},
              {{2000,1,4},{9,0,0}},
              {{2000,1,5},{9,0,0}},
              {{2000,1,6},{9,0,0}},
              {{2000,1,7},{9,0,0}},
              {{2000,1,8},{9,0,0}},
              {{2000,1,9},{9,0,0}},
              {{2000,1,10},{9,0,0}},
              {{2000,1,11},{9,0,0}},
              {{2000,1,12},{9,0,0}},
              {{2000,1,13},{9,0,0}},
              {{2000,1,14},{9,0,0}},
              {{2000,1,15},{9,0,0}},
              {{2000,1,16},{9,0,0}},
              {{2000,1,17},{9,0,0}},
              {{2000,1,18},{9,0,0}},
              {{2000,1,19},{9,0,0}},
              {{2000,1,20},{9,0,0}},
              {{2000,1,21},{9,0,0}},
              {{2000,1,22},{9,0,0}},
              {{2000,1,23},{9,0,0}},
              {{2000,1,24},{9,0,0}},
              {{2000,1,25},{9,0,0}},
              {{2000,1,26},{9,0,0}},
              {{2000,1,27},{9,0,0}},
              {{2000,1,28},{9,0,0}},
              {{2000,1,29},{9,0,0}},
              {{2000,1,30},{9,0,0}},
              {{2000,1,31},{9,0,0}}],
    rrule_test("RRULE:FREQ=YEARLY;UNTIL=20000131T090000Z;BYMONTH=1;BYDAY=SU,MO,TU,WE,TH,FR,SA",
               "19980101T090000Z", Result),
    rrule_test("RRULE:FREQ=DAILY;UNTIL=20000131T090000Z;BYMONTH=1",
               "19980101T090000Z", Result).

rrule_example6_test() ->
    rrule_test("RRULE:FREQ=WEEKLY;COUNT=10",
               "19970902T090000Z",
               [{{1997,9,2},{9,0,0}},
                {{1997,9,9},{9,0,0}},
                {{1997,9,16},{9,0,0}},
                {{1997,9,23},{9,0,0}},
                {{1997,9,30},{9,0,0}},
                {{1997,10,7},{9,0,0}},
                {{1997,10,14},{9,0,0}},
                {{1997,10,21},{9,0,0}},
                {{1997,10,28},{9,0,0}},
                {{1997,11,4},{9,0,0}}]).

rrule_example7_test() ->
    rrule_test("RRULE:FREQ=WEEKLY;UNTIL=19971224T000000Z",
               "19970902T090000Z",
               [{{1997,9,2},{9,0,0}},
                {{1997,9,9},{9,0,0}},
                {{1997,9,16},{9,0,0}},
                {{1997,9,23},{9,0,0}},
                {{1997,9,30},{9,0,0}},
                {{1997,10,7},{9,0,0}},
                {{1997,10,14},{9,0,0}},
                {{1997,10,21},{9,0,0}},
                {{1997,10,28},{9,0,0}},
                {{1997,11,4},{9,0,0}},
                {{1997,11,11},{9,0,0}},
                {{1997,11,18},{9,0,0}},
                {{1997,11,25},{9,0,0}},
                {{1997,12,2},{9,0,0}},
                {{1997,12,9},{9,0,0}},
                {{1997,12,16},{9,0,0}},
                {{1997,12,23},{9,0,0}}]).

rrule_example8_test() ->
    rrule_test("RRULE:FREQ=WEEKLY;INTERVAL=2;WKST=SU",
               "19970902T090000Z",
               {undefined, {{1998, 2, 1}, {0, 0, 0}}},
               [{{1997,9,2},{9,0,0}},
                {{1997,9,16},{9,0,0}},
                {{1997,9,30},{9,0,0}},
                {{1997,10,14},{9,0,0}},
                {{1997,10,28},{9,0,0}},
                {{1997,11,11},{9,0,0}},
                {{1997,11,25},{9,0,0}},
                {{1997,12,9},{9,0,0}},
                {{1997,12,23},{9,0,0}},
                {{1998,1,6},{9,0,0}},
                {{1998,1,20},{9,0,0}}]).

rrule_example9_test() ->
    Result = [{{1997,9,2},{9,0,0}},
              {{1997,9,4},{9,0,0}},
              {{1997,9,9},{9,0,0}},
              {{1997,9,11},{9,0,0}},
              {{1997,9,16},{9,0,0}},
              {{1997,9,18},{9,0,0}},
              {{1997,9,23},{9,0,0}},
              {{1997,9,25},{9,0,0}},
              {{1997,9,30},{9,0,0}},
              {{1997,10,2},{9,0,0}}],
    rrule_test("RRULE:FREQ=WEEKLY;UNTIL=19971007T000000Z;WKST=SU;BYDAY=TU,TH",
               "19970902T090000Z", Result),
    rrule_test("RRULE:FREQ=WEEKLY;COUNT=10;WKST=SU;BYDAY=TU,TH",
               "19970902T090000Z", Result).

rrule_example10_test() ->
    rrule_test("RRULE:FREQ=WEEKLY;INTERVAL=2;UNTIL=19971224T000000Z;WKST=SU;BYDAY=MO,WE,FR",
               "19970902T090000Z",
               [{{1997,9,2},{9,0,0}},
                {{1997,9,3},{9,0,0}},
                {{1997,9,5},{9,0,0}},
                {{1997,9,15},{9,0,0}},
                {{1997,9,17},{9,0,0}},
                {{1997,9,19},{9,0,0}},
                {{1997,9,29},{9,0,0}},
                {{1997,10,1},{9,0,0}},
                {{1997,10,3},{9,0,0}},
                {{1997,10,13},{9,0,0}},
                {{1997,10,15},{9,0,0}},
                {{1997,10,17},{9,0,0}},
                {{1997,10,27},{9,0,0}},
                {{1997,10,29},{9,0,0}},
                {{1997,10,31},{9,0,0}},
                {{1997,11,10},{9,0,0}},
                {{1997,11,12},{9,0,0}},
                {{1997,11,14},{9,0,0}},
                {{1997,11,24},{9,0,0}},
                {{1997,11,26},{9,0,0}},
                {{1997,11,28},{9,0,0}},
                {{1997,12,8},{9,0,0}},
                {{1997,12,10},{9,0,0}},
                {{1997,12,12},{9,0,0}},
                {{1997,12,22},{9,0,0}}]).

rrule_example11_test() ->
    rrule_test("RRULE:FREQ=WEEKLY;INTERVAL=2;COUNT=8;WKST=SU;BYDAY=TU,TH",
               "19970902T090000Z",
               [{{1997,9,2},{9,0,0}},
                {{1997,9,4},{9,0,0}},
                {{1997,9,16},{9,0,0}},
                {{1997,9,18},{9,0,0}},
                {{1997,9,30},{9,0,0}},
                {{1997,10,2},{9,0,0}},
                {{1997,10,14},{9,0,0}},
                {{1997,10,16},{9,0,0}}]).

rrule_example12_test() ->
    rrule_test("RRULE:FREQ=MONTHLY;COUNT=10;BYDAY=1FR",
               "19970905T090000Z",
               [{{1997,9,5},{9,0,0}},
                {{1997,10,3},{9,0,0}},
                {{1997,11,7},{9,0,0}},
                {{1997,12,5},{9,0,0}},
                {{1998,1,2},{9,0,0}},
                {{1998,2,6},{9,0,0}},
                {{1998,3,6},{9,0,0}},
                {{1998,4,3},{9,0,0}},
                {{1998,5,1},{9,0,0}},
                {{1998,6,5},{9,0,0}}]).

rrule_example13_test() ->
    rrule_test("RRULE:FREQ=MONTHLY;UNTIL=19971224T000000Z;BYDAY=1FR",
               "19970905T090000Z",
               [{{1997,9,5},{9,0,0}},
                {{1997,10,3},{9,0,0}},
                {{1997,11,7},{9,0,0}},
                {{1997,12,5},{9,0,0}}]).

rrule_example14_test() ->
    rrule_test("RRULE:FREQ=MONTHLY;INTERVAL=2;COUNT=10;BYDAY=1SU,-1SU",
               "19970907T090000Z",
               [{{1997,9,7},{9,0,0}},
                {{1997,9,28},{9,0,0}},
                {{1997,11,2},{9,0,0}},
                {{1997,11,30},{9,0,0}},
                {{1998,1,4},{9,0,0}},
                {{1998,1,25},{9,0,0}},
                {{1998,3,1},{9,0,0}},
                {{1998,3,29},{9,0,0}},
                {{1998,5,3},{9,0,0}},
                {{1998,5,31},{9,0,0}}]).

rrule_example15_test() ->
    rrule_test("RRULE:FREQ=MONTHLY;COUNT=6;BYDAY=-2MO",
               "19970922T090000Z",
               [{{1997,9,22},{9,0,0}},
                {{1997,10,20},{9,0,0}},
                {{1997,11,17},{9,0,0}},
                {{1997,12,22},{9,0,0}},
                {{1998,1,19},{9,0,0}},
                {{1998,2,16},{9,0,0}}]).

rrule_example16_test() ->
    rrule_test("RRULE:FREQ=MONTHLY;BYMONTHDAY=-3",
               "19970928T090000Z",
               {undefined, {{1998, 2, 27}, {0, 0, 0}}},
               [{{1997,9,28},{9,0,0}},
                {{1997,10,29},{9,0,0}},
                {{1997,11,28},{9,0,0}},
                {{1997,12,29},{9,0,0}},
                {{1998,1,29},{9,0,0}},
                {{1998,2,26},{9,0,0}}]).

rrule_example17_test() ->
    rrule_test("RRULE:FREQ=MONTHLY;COUNT=10;BYMONTHDAY=2,15",
               "19970902T090000Z",
               [{{1997,9,2},{9,0,0}},
                {{1997,9,15},{9,0,0}},
                {{1997,10,2},{9,0,0}},
                {{1997,10,15},{9,0,0}},
                {{1997,11,2},{9,0,0}},
                {{1997,11,15},{9,0,0}},
                {{1997,12,2},{9,0,0}},
                {{1997,12,15},{9,0,0}},
                {{1998,1,2},{9,0,0}},
                {{1998,1,15},{9,0,0}}]).

rrule_example18_test() ->
    rrule_test("RRULE:FREQ=MONTHLY;COUNT=10;BYMONTHDAY=1,-1",
               "19970930T090000Z",
               [{{1997,9,30},{9,0,0}},
                {{1997,10,1},{9,0,0}},
                {{1997,10,31},{9,0,0}},
                {{1997,11,1},{9,0,0}},
                {{1997,11,30},{9,0,0}},
                {{1997,12,1},{9,0,0}},
                {{1997,12,31},{9,0,0}},
                {{1998,1,1},{9,0,0}},
                {{1998,1,31},{9,0,0}},
                {{1998,2,1},{9,0,0}}]).

rrule_example19_test() ->
    rrule_test("RRULE:FREQ=MONTHLY;INTERVAL=18;COUNT=10;BYMONTHDAY=10,11,12,13,14,15",
               "19970910T090000Z",
               [{{1997,9,10},{9,0,0}},
                {{1997,9,11},{9,0,0}},
                {{1997,9,12},{9,0,0}},
                {{1997,9,13},{9,0,0}},
                {{1997,9,14},{9,0,0}},
                {{1997,9,15},{9,0,0}},
                {{1999,3,10},{9,0,0}},
                {{1999,3,11},{9,0,0}},
                {{1999,3,12},{9,0,0}},
                {{1999,3,13},{9,0,0}}]).

rrule_example20_test() ->
    rrule_test("RRULE:FREQ=MONTHLY;INTERVAL=2;BYDAY=TU",
               "19970902T090000Z",
               {undefined, {{1998, 4, 1}, {0, 0, 0}}},
               [{{1997,9,2},{9,0,0}},
                {{1997,9,9},{9,0,0}},
                {{1997,9,16},{9,0,0}},
                {{1997,9,23},{9,0,0}},
                {{1997,9,30},{9,0,0}},
                {{1997,11,4},{9,0,0}},
                {{1997,11,11},{9,0,0}},
                {{1997,11,18},{9,0,0}},
                {{1997,11,25},{9,0,0}},
                {{1998,1,6},{9,0,0}},
                {{1998,1,13},{9,0,0}},
                {{1998,1,20},{9,0,0}},
                {{1998,1,27},{9,0,0}},
                {{1998,3,3},{9,0,0}},
                {{1998,3,10},{9,0,0}},
                {{1998,3,17},{9,0,0}},
                {{1998,3,24},{9,0,0}},
                {{1998,3,31},{9,0,0}}]).

rrule_example21_test() ->
    rrule_test("RRULE:FREQ=YEARLY;COUNT=10;BYMONTH=6,7",
               "19970610T090000Z",
               [{{1997,6,10},{9,0,0}},
                {{1997,7,10},{9,0,0}},
                {{1998,6,10},{9,0,0}},
                {{1998,7,10},{9,0,0}},
                {{1999,6,10},{9,0,0}},
                {{1999,7,10},{9,0,0}},
                {{2000,6,10},{9,0,0}},
                {{2000,7,10},{9,0,0}},
                {{2001,6,10},{9,0,0}},
                {{2001,7,10},{9,0,0}}]).

rrule_example22_test() ->
    rrule_test("RRULE:FREQ=YEARLY;INTERVAL=2;COUNT=10;BYMONTH=1,2,3",
               "19970310T090000Z",
               [{{1997,3,10},{9,0,0}},
                {{1999,1,10},{9,0,0}},
                {{1999,2,10},{9,0,0}},
                {{1999,3,10},{9,0,0}},
                {{2001,1,10},{9,0,0}},
                {{2001,2,10},{9,0,0}},
                {{2001,3,10},{9,0,0}},
                {{2003,1,10},{9,0,0}},
                {{2003,2,10},{9,0,0}},
                {{2003,3,10},{9,0,0}}]).

rrule_example23_test() ->
    _ = {not_supported,
         "RRULE:FREQ=YEARLY;INTERVAL=3;COUNT=10;BYYEARDAY=1,100,200",
         "19970101T090000Z"},
    ok.

rrule_example24_test() ->
    _ = {not_supported,
         "RRULE:FREQ=YEARLY;BYDAY=20MO",
         "19970519T090000"},
    ok.

rrule_example25_test() ->
    _ = {not_supported,
         "RRULE:FREQ=YEARLY;BYWEEKNO=20;BYDAY=MO",
         "19970512T090000"},
    ok.

rrule_example26_test() ->
    rrule_test("RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=TH",
               "19970313T090000Z",
               {undefined, {{1999, 3, 26}, {0, 0, 0}}},
               [{{1997,3,13},{9,0,0}},
                {{1997,3,20},{9,0,0}},
                {{1997,3,27},{9,0,0}},
                {{1998,3,5},{9,0,0}},
                {{1998,3,12},{9,0,0}},
                {{1998,3,19},{9,0,0}},
                {{1998,3,26},{9,0,0}},
                {{1999,3,4},{9,0,0}},
                {{1999,3,11},{9,0,0}},
                {{1999,3,18},{9,0,0}},
                {{1999,3,25},{9,0,0}}]).

rrule_example27_test() ->
    rrule_test("RRULE:FREQ=YEARLY;BYDAY=TH;BYMONTH=6,7,8",
               "19970605T090000Z",
               {undefined, {{1999, 8, 26}, {9, 0, 0}}},
               [{{1997,6,5},{9,0,0}},
                {{1997,6,12},{9,0,0}},
                {{1997,6,19},{9,0,0}},
                {{1997,6,26},{9,0,0}},
                {{1997,7,3},{9,0,0}},
                {{1997,7,10},{9,0,0}},
                {{1997,7,17},{9,0,0}},
                {{1997,7,24},{9,0,0}},
                {{1997,7,31},{9,0,0}},
                {{1997,8,7},{9,0,0}},
                {{1997,8,14},{9,0,0}},
                {{1997,8,21},{9,0,0}},
                {{1997,8,28},{9,0,0}},
                {{1998,6,4},{9,0,0}},
                {{1998,6,11},{9,0,0}},
                {{1998,6,18},{9,0,0}},
                {{1998,6,25},{9,0,0}},
                {{1998,7,2},{9,0,0}},
                {{1998,7,9},{9,0,0}},
                {{1998,7,16},{9,0,0}},
                {{1998,7,23},{9,0,0}},
                {{1998,7,30},{9,0,0}},
                {{1998,8,6},{9,0,0}},
                {{1998,8,13},{9,0,0}},
                {{1998,8,20},{9,0,0}},
                {{1998,8,27},{9,0,0}},
                {{1999,6,3},{9,0,0}},
                {{1999,6,10},{9,0,0}},
                {{1999,6,17},{9,0,0}},
                {{1999,6,24},{9,0,0}},
                {{1999,7,1},{9,0,0}},
                {{1999,7,8},{9,0,0}},
                {{1999,7,15},{9,0,0}},
                {{1999,7,22},{9,0,0}},
                {{1999,7,29},{9,0,0}},
                {{1999,8,5},{9,0,0}},
                {{1999,8,12},{9,0,0}},
                {{1999,8,19},{9,0,0}},
                {{1999,8,26},{9,0,0}}]).

rrule_example28_test() ->
    Start = <<"19970902T090000Z">>,
    Rules = [<<"RRULE:FREQ=MONTHLY;BYDAY=FR;BYMONTHDAY=13">>, <<"EXDATE:19970902T090000Z">>],
    Result = [{{1998,2,13},{9,0,0}},
              {{1998,3,13},{9,0,0}},
              {{1998,11,13},{9,0,0}},
              {{1999,8,13},{9,0,0}},
              {{2000,10,13},{9,0,0}}],
    ?assertMatch(Result, ical:recur(ical:parse(date, Start),
                                    ical:rrule(Rules),
                                    {undefined, {{2000, 10, 14}, {0, 0, 0}}})).

rrule_example29_test() ->
    rrule_test("RRULE:FREQ=MONTHLY;BYDAY=SA;BYMONTHDAY=7,8,9,10,11,12,13",
               "19970913T090000Z",
               {undefined, {{1998, 6, 14}, {0, 0, 0}}},
               [{{1997,9,13},{9,0,0}},
                {{1997,10,11},{9,0,0}},
                {{1997,11,8},{9,0,0}},
                {{1997,12,13},{9,0,0}},
                {{1998,1,10},{9,0,0}},
                {{1998,2,7},{9,0,0}},
                {{1998,3,7},{9,0,0}},
                {{1998,4,11},{9,0,0}},
                {{1998,5,9},{9,0,0}},
                {{1998,6,13},{9,0,0}}]).

rrule_example30_test() ->
    rrule_test("RRULE:FREQ=YEARLY;INTERVAL=4;BYMONTH=11;BYDAY=TU;BYMONTHDAY=2,3,4,5,6,7,8",
               "19961105T090000Z",
               {undefined, {{2004, 12, 1}, {0, 0, 0}}},
               [{{1996,11,5},{9,0,0}},
                {{2000,11,7},{9,0,0}},
                {{2004,11,2},{9,0,0}}]).

rrule_example31_test() ->
    _ = {not_supported,
         "RRULE:FREQ=MONTHLY;COUNT=3;BYDAY=TU,WE,TH;BYSETPOS=3",
         "19970904T090000Z"},
    ok.


rrule_example32_test() ->
    _ = {not_supported,
         "RRULE:FREQ=MONTHLY;BYDAY=MO,TU,WE,TH,FR;BYSETPOS=-2",
         "19970929T090000Z"},
    ok.

rrule_example33_test() ->
    rrule_test("RRULE:FREQ=HOURLY;INTERVAL=3;UNTIL=19970902T170000Z",
               "19970902T090000Z",
               [{{1997,9,2},{9,0,0}},
                {{1997,9,2},{12,0,0}},
                {{1997,9,2},{15,0,0}}]).

rrule_example34_test() ->
    rrule_test("RRULE:FREQ=MINUTELY;INTERVAL=15;COUNT=6",
               "19970902T090000Z",
               [{{1997,9,2},{9,0,0}},
                {{1997,9,2},{9,15,0}},
                {{1997,9,2},{9,30,0}},
                {{1997,9,2},{9,45,0}},
                {{1997,9,2},{10,0,0}},
                {{1997,9,2},{10,15,0}}]).

rrule_example35_test() ->
    rrule_test("RRULE:FREQ=MINUTELY;INTERVAL=90;COUNT=4",
               "19970902T090000Z",
               [{{1997,9,2},{9,0,0}},
                {{1997,9,2},{10,30,0}},
                {{1997,9,2},{12,0,0}},
                {{1997,9,2},{13,30,0}}]).

rrule_example36_test() ->
    Result = [{{1997,9,2},{9,0,0}},
              {{1997,9,2},{9,20,0}},
              {{1997,9,2},{9,40,0}},
              {{1997,9,2},{10,0,0}},
              {{1997,9,2},{10,20,0}},
              {{1997,9,2},{10,40,0}},
              {{1997,9,2},{11,0,0}},
              {{1997,9,2},{11,20,0}},
              {{1997,9,2},{11,40,0}},
              {{1997,9,2},{12,0,0}},
              {{1997,9,2},{12,20,0}},
              {{1997,9,2},{12,40,0}},
              {{1997,9,2},{13,0,0}},
              {{1997,9,2},{13,20,0}},
              {{1997,9,2},{13,40,0}},
              {{1997,9,2},{14,0,0}},
              {{1997,9,2},{14,20,0}},
              {{1997,9,2},{14,40,0}},
              {{1997,9,2},{15,0,0}},
              {{1997,9,2},{15,20,0}},
              {{1997,9,2},{15,40,0}},
              {{1997,9,2},{16,0,0}},
              {{1997,9,2},{16,20,0}},
              {{1997,9,2},{16,40,0}},
              {{1997,9,3},{9,0,0}},
              {{1997,9,3},{9,20,0}},
              {{1997,9,3},{9,40,0}},
              {{1997,9,3},{10,0,0}},
              {{1997,9,3},{10,20,0}},
              {{1997,9,3},{10,40,0}},
              {{1997,9,3},{11,0,0}},
              {{1997,9,3},{11,20,0}},
              {{1997,9,3},{11,40,0}},
              {{1997,9,3},{12,0,0}},
              {{1997,9,3},{12,20,0}},
              {{1997,9,3},{12,40,0}},
              {{1997,9,3},{13,0,0}},
              {{1997,9,3},{13,20,0}},
              {{1997,9,3},{13,40,0}},
              {{1997,9,3},{14,0,0}},
              {{1997,9,3},{14,20,0}},
              {{1997,9,3},{14,40,0}},
              {{1997,9,3},{15,0,0}},
              {{1997,9,3},{15,20,0}},
              {{1997,9,3},{15,40,0}},
              {{1997,9,3},{16,0,0}},
              {{1997,9,3},{16,20,0}},
              {{1997,9,3},{16,40,0}}],
    rrule_test("RRULE:FREQ=DAILY;BYHOUR=9,10,11,12,13,14,15,16;BYMINUTE=0,20,40",
               "19970902T090000Z", {undefined, {{1997, 9, 3}, {16, 40, 0}}}, Result),
    rrule_test("RRULE:FREQ=MINUTELY;INTERVAL=20;BYHOUR=9,10,11,12,13,14,15,16",
               "19970902T090000Z", {undefined, {{1997, 9, 3}, {16, 40, 0}}}, Result).

rrule_example37_test() ->
    rrule_test("RRULE:FREQ=WEEKLY;INTERVAL=2;COUNT=4;BYDAY=TU,SU;WKST=MO",
               "19970805T090000Z",
               [{{1997,8,5},{9,0,0}},
                {{1997,8,10},{9,0,0}},
                {{1997,8,19},{9,0,0}},
                {{1997,8,24},{9,0,0}}]),
    rrule_test("RRULE:FREQ=WEEKLY;INTERVAL=2;COUNT=4;BYDAY=TU,SU;WKST=SU",
               "19970805T090000Z",
               [{{1997,8,5},{9,0,0}},
                {{1997,8,17},{9,0,0}},
                {{1997,8,19},{9,0,0}},
                {{1997,8,31},{9,0,0}}]).

rrule_infinite_test() ->
    Rule = ical:rrule([<<"RRULE:FREQ=DAILY;WKST=SU;UNTIL=20061116">>]),
    Start = {{2006, 11, 15}, {0, 0, 0}},
    ?assertMatch({{2006,11,16},{0,0,0}}, ical:final(Start, Rule)).
